# airflow-prod values.yaml

airflow:
  images:
    airflow:
      tag: latest
  
  # 기준값: 환경별 airflow 도메인
  global:
    airflowHost: airflow.prod  # ⬅️ 모든 host 관련 값의 기준값
  
  dags:
    gitSync:
      enabled: true
      repo: git@github.com:keonhoban/airflow-dags.git
      branch: main
      subPath: dags
      depth: 1
      wait: 10
      rev: HEAD
      sshKeySecret: airflow-git-ssh-secret
  
  # Airflow config 직접 정의 (공식 Helm Chart의 config 블록)
  config:
    AIRFLOW__WEBSERVER__WEB_SERVER_BASE_URL:
      value: "http://airflow.prod"  # ⬅️ global.airflowHost 기준값

  apiSecretKeySecretName: airflow-prod-api-secret-key
  jwtSecretName:          airflow-prod-jwt-secret
  apiSecretKey: ~
  jwtSecret:    ~
  
  # Fernet Key / Metadata DB 관련 시크릿
  fernetKeySecretName: airflow-fernet-prod-secret
  
  data:
    metadataSecretName: airflow-db-prod-secret
  
  # Scheduler 설정 (Anchor 정의)
  scheduler: &prod_scheduler
    env:
      - name: RELOAD_SECRET_TOKEN
        valueFrom:
          secretKeyRef:
            name: fastapi-token-prod-secret
            key: RELOAD_SECRET_TOKEN
      - name: SLACK_WEBHOOK_URL
        valueFrom:
          secretKeyRef:
            name: slack-webhook-prod-secret
            key: SLACK_WEBHOOK_URL
  
      - name: MLFLOW_TRACKING_URI
        value: "http://mlflow-prod-service.mlflow-prod.svc.cluster.local:5000"
      - name: FASTAPI_RELOAD_URL
        value: "http://fastapi-prod-service.fastapi-prod.svc.cluster.local"
      - name: AIRFLOW__LOGGING__REMOTE_LOGGING
        value: "True"
      - name: AIRFLOW__LOGGING__REMOTE_BASE_LOG_FOLDER
        value: "s3://mlflow-artifacts-keonho/prod/airflow-logs"
      - name: AIRFLOW__LOGGING__REMOTE_LOG_CONN_ID
        value: "aws_default"
  
    resources:
      requests:
        cpu: "1"
        memory: "1Gi"
      limits:
        cpu: "2"
        memory: "2Gi"
  
    extraVolumes:
      - name: aws-credentials
        secret:
          secretName: aws-credentials-secret
    extraVolumeMounts:
      - name: aws-credentials
        mountPath: /home/airflow/.aws
        readOnly: true
  
  # Workers / DAG Processor 에 동일 anchor 사용
  workers: *prod_scheduler
  dagProcessor: *prod_scheduler
  
  # Ingress 설정
  ingress:
    web:
      enabled: true
      ingressClassName: nginx
      annotations:
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
      hosts:
        - name: airflow.prod
          tls:
            enabled: true
            secretName: airflow-prod-tls   # <-- cert-manager가 만든 Secret
