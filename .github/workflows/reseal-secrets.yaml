name: Reseal SealedSecrets

on:
  # 매월 1일 14:25 KST(=05:25 UTC) 자동 실행
  schedule:
    - cron: "25 5 1 * *"
  # 필요 시 수동 실행
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: reseal-sealedsecrets
  cancel-in-progress: false

env:
  CERT_PATH: bootstrap/certs/sealed-secrets-20250804.pem
  PR_BRANCH: chore/reseal-secrets
  PR_TITLE: "chore(secrets): reseal SealedSecrets with pinned cert"
  PR_BODY: "자동화된 reseal job (offline, pinned cert). 변경 없으면 PR 생기지 않습니다."
  KUBESEAL_VERSION: "0.27.2"

jobs:
  reseal:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install kubeseal
        run: |
          set -euo pipefail
          curl -sSL -o kubeseal.tar.gz \
            https://github.com/bitnami-labs/sealed-secrets/releases/download/v${KUBESEAL_VERSION}/kubeseal-${KUBESEAL_VERSION}-linux-amd64.tar.gz
          tar xzf kubeseal.tar.gz
          sudo mv kubeseal /usr/local/bin/
          kubeseal --version

      - name: Check pinned cert exists & print fingerprint
        run: |
          set -euo pipefail
          test -f "${CERT_PATH}"
          openssl x509 -in "${CERT_PATH}" -noout -fingerprint -dates -subject

      - id: reseal
        name: Reseal all secrets (OFFLINE with pinned cert)
        shell: bash
        run: |
          set -euo pipefail

          # 대상 파일 탐색 (envs/dev|prod/sealed-secrets 폴더의 yaml/yml)
          mapfile -t FILES < <(git ls-files | grep -E '^envs/(dev|prod)/sealed-secrets/.+\.ya?ml$' || true)

          if [[ ${#FILES[@]} -eq 0 ]]; then
            echo "no_files=true" >> "$GITHUB_OUTPUT"
            echo "변환 대상 SealedSecret 파일이 없습니다. 스킵합니다."
            exit 0
          fi

          echo "총 ${#FILES[@]}개 파일 reseal 진행"
          for f in "${FILES[@]}"; do
            echo "::group::reseal $f"
            kubeseal \
              --cert="${CERT_PATH}" \
              --format=yaml \
              --re-encrypt < "$f" > resealed.yaml
            mv resealed.yaml "$f"
            echo "::endgroup::"
          done

          # 변경 여부 판단
          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "reseal 결과 변경 사항 없음 (idempotent)."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "reseal 결과 변경 발생."
          fi

      - name: Configure git user
        if: steps.reseal.outputs.changed == 'true'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create Pull Request
        if: steps.reseal.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ env.PR_BRANCH }}
          title: ${{ env.PR_TITLE }}
          commit-message: ${{ env.PR_TITLE }}
          body: ${{ env.PR_BODY }}
          delete-branch: true

      - name: No-op summary
        if: steps.reseal.outputs.changed != 'true'
        run: echo "변경 사항이 없어 PR을 생성하지 않았습니다 ✅"
