apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: triton-alerts
  namespace: monitoring-prod
  labels:
    release: monitoring-prod
spec:
  groups:
    - name: triton.rules
      rules:
        - alert: TritonHighErrorRatio
          expr: |
            (
              sum(increase(nv_inference_request_failure{job="triton"}[5m]))
              /
              clamp_min(
                sum(increase(nv_inference_request_failure{job="triton"}[5m]))
                + sum(increase(nv_inference_request_success{job="triton"}[5m])),
                1
              )
            ) > 0.01
          for: 3m
          labels:
            severity: warning
            service: triton
            env: prod
          annotations:
            summary: "Triton error ratio is high (prod)"
            description: |
              Triton failure ratio > 1% for 3m.
              value={{ $value }}
              job=triton

        - alert: TritonHighLatencyAvg
          expr: |
            (
              sum(increase(nv_inference_request_duration_us{job="triton"}[5m]))
              /
              clamp_min(sum(increase(nv_inference_count{job="triton"}[5m])), 1)
            ) > 300000
          for: 5m
          labels:
            severity: warning
            service: triton
            env: prod
          annotations:
            summary: "Triton average latency is high (prod)"
            description: |
              Avg latency > 300ms for 5m (estimated).
              value_us={{ $value }}
              job=triton
