apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  service.slack: |
    webhook: $slack-webhook

  context: |
    argocdUrl: https://argocd.local

  template.app-sync-status: |
    message: |
      *[{{.app.metadata.name}}]* Sync *{{.app.status.sync.status}}* → Health *{{.app.status.health.status}}*
      · Rev: `{{.app.status.sync.revision}}`
      <{{.context.argocdUrl}}/applications/{{.app.metadata.name}}|Open in ArgoCD>
    slack:
      attachments:
      - title: "ArgoCD · {{.app.metadata.name}}"
        title_link: "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}"
        text: "Project: `{{.app.spec.project}}`\nSync: `{{.app.status.sync.status}}`\nHealth: `{{.app.status.health.status}}`"
        mrkdwn_in: ["text"]

  template.app-sync-failed: |
    message: |
      *[{{.app.metadata.name}}]* ❌ Sync *Failed*
      · Phase: `{{.app.status.operationState.phase}}`
      · Msg: `{{.app.status.operationState.message}}`
      <{{.context.argocdUrl}}/applications/{{.app.metadata.name}}|Open in ArgoCD>

  template.app-health-degraded: |
    message: |
      *[{{.app.metadata.name}}]* ⚠️ Health *Degraded*
      · Health: `{{.app.status.health.status}}`, Sync: `{{.app.status.sync.status}}`
      <{{.context.argocdUrl}}/applications/{{.app.metadata.name}}|Open in ArgoCD>

  trigger.on-sync-status-change: |
    - when: app.status.sync.status in ['Synced', 'OutOfSync']
      send: [app-sync-status]

  trigger.on-sync-failed: |
    - when: app.status.operationState.phase in ['Error', 'Failed']
      send: [app-sync-failed]

  trigger.on-health-degraded: |
    - when: app.status.health.status == 'Degraded'
      send: [app-health-degraded]

  subscriptions: |
    - recipients:
        - slack:#argocd
      triggers:
        - on-sync-status-change
        - on-sync-failed
        - on-health-degraded
