apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: triton-alerts
  namespace: observability-prod
  labels:
    release: monitoring-prod
spec:
  groups:
  - name: triton.rules
    rules:
    - alert: TritonHighErrorRate
      expr: |
        (
          sum(rate(nv_inference_request_failure{job="triton"}[5m]))
        /
          clamp_min(
            sum(rate(nv_inference_request_success{job="triton"}[5m]))
          + sum(rate(nv_inference_request_failure{job="triton"}[5m])),
          1
          )
        ) > 0.02
      for: 2m
      labels:
        severity: warning
        namespace: triton-prod
        service: triton
      annotations:
        summary: "[PROD] Triton error rate high"
        description: "Triton error rate > 2% (5m). value={{ $value }}"

    - alert: TritonMeanLatencyHigh
      expr: |
        (
          sum(rate(nv_inference_request_duration_us{job="triton"}[5m]))
        /
          clamp_min(sum(rate(nv_inference_count{job="triton"}[5m])), 1)
        ) / 1e6 > 0.5
      for: 5m
      labels:
        severity: warning
        namespace: triton-prod
        service: triton
      annotations:
        summary: "[PROD] Triton mean latency high"
        description: "Triton mean latency > 0.5s (5m). value={{ $value }}"
