apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: promtail-env-matrix
  namespace: argocd
  labels:
    scope: optional
spec:
  generators:
    - list:
        elements:
          - env: dev
            ns: observability-dev
            project: dev
            valuesPath: optional/envs/dev/observability/promtail-values.yaml
          - env: prod
            ns: observability-prod
            project: prod
            valuesPath: optional/envs/prod/observability/promtail-values.yaml
  template:
    metadata:
      name: 'promtail-{{env}}'
      labels:
        scope: optional
      annotations:
        argocd.argoproj.io/sync-wave: "1"
    spec:
      project: '{{project}}'
      destination:
        server: 'https://kubernetes.default.svc'
        namespace: '{{ns}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
      sources:
        - repoURL: 'https://grafana.github.io/helm-charts'
          chart: promtail
          targetRevision: '6.*'
          helm:
            valueFiles:
              - '$values/{{valuesPath}}'
        - repoURL: 'https://github.com/keonhoban/mlops-infra-gitops'
          targetRevision: main
          ref: values
