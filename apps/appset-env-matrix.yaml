apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: mlops-appset
  namespace: argocd
spec:
  generators:
    - matrix:
        generators:
          # ① 환경 목록
          - list:
              elements:
                - env: dev
                  project: dev
                  values_suffix: dev
                - env: prod
                  project: prod
                  values_suffix: prod
          # ② 서비스 목록
          - list:
              elements:
                - service: mlflow
                  path: charts/mlflow
                - service: airflow
                  path: charts/airflow
                - service: fastapi
                  path: charts/fastapi
  template:
    metadata:
      # 예: mlflow-dev, airflow-prod ...
      name: '{{service}}-{{env}}'
      annotations:
        # sealed-secrets(0) 이후에 배포
        argocd.argoproj.io/sync-wave: "1"
    spec:
      project: '{{project}}'
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{service}}-{{env}}'
      source:
        repoURL: 'https://github.com/keonhoban/mlops-infra-gitops'
        targetRevision: main
        path: '{{path}}'
        helm:
          # releaseName도 동일 규칙
          releaseName: '{{service}}-{{env}}'
          valueFiles:
            - 'values/base.yaml'
            - 'values/{{values_suffix}}.yaml'   # charts/<svc>/values/dev.yaml|prod.yaml
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
