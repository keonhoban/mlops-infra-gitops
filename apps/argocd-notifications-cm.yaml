apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  # Slack ì—°ë™ (SealedSecretì˜ key ì´ë¦„ê³¼ ì¼ì¹˜: slack-token)
  service.slack: |
    token: $slack-webhook

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€ Triggers (ì–¸ì œ ë³´ë‚¼ì§€) â”€â”€â”€â”€â”€â”€â”€â”€â”€
  trigger.on-sync-succeeded: |
    - when: app.status.operationState.phase == 'Succeeded'
      send: [slack-sync-succeeded]
  trigger.on-sync-failed: |
    - when: app.status.operationState.phase in ['Error','Failed']
      send: [slack-sync-failed]
  trigger.on-health-degraded: |
    - when: app.status.health.status == 'Degraded'
      send: [slack-health-degraded]
  trigger.on-outofsync: |
    - when: app.status.sync.status == 'OutOfSync'
      send: [slack-outofsync]

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€ Templates (ë¬´ì—‡ì„ ë³´ë‚¼ì§€) â”€â”€â”€â”€â”€â”€â”€â”€â”€
  template.slack-sync-succeeded: |
    message: |
      âœ… *{{app.metadata.name}}* Sync succeeded
      Namespace: `{{app.spec.destination.namespace}}`
      Revision: `{{app.status.sync.revision}}`
      <{{context.argocdUrl}}/applications/{{app.metadata.name}}|Open in ArgoCD>
  template.slack-sync-failed: |
    message: |
      ğŸ”¥ *{{app.metadata.name}}* Sync failed
      Status: `{{app.status.operationState.phase}}`
      {{if app.status.operationState.message}}Msg: `{{app.status.operationState.message}}`{{end}}
      <{{context.argocdUrl}}/applications/{{app.metadata.name}}|Open in ArgoCD>
  template.slack-health-degraded: |
    message: |
      âš ï¸ *{{app.metadata.name}}* Health: Degraded
      <{{context.argocdUrl}}/applications/{{app.metadata.name}}|Open in ArgoCD>
  template.slack-outofsync: |
    message: |
      âš ï¸ *{{app.metadata.name}}* OutOfSync (Drift detected)
      <{{context.argocdUrl}}/applications/{{app.metadata.name}}|Open in ArgoCD>
