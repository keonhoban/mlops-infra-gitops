apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  # Slack 연동 (SealedSecret의 key 이름과 일치: slack-token)
  service.slack: |
    token: $slack-webhook

  # ───────── Triggers (언제 보낼지) ─────────
  trigger.on-sync-succeeded: |
    - when: app.status.operationState.phase == 'Succeeded'
      send: [slack-sync-succeeded]
  trigger.on-sync-failed: |
    - when: app.status.operationState.phase in ['Error','Failed']
      send: [slack-sync-failed]
  trigger.on-health-degraded: |
    - when: app.status.health.status == 'Degraded'
      send: [slack-health-degraded]
  trigger.on-outofsync: |
    - when: app.status.sync.status == 'OutOfSync'
      send: [slack-outofsync]

  # ───────── Templates (무엇을 보낼지) ─────────
  template.slack-sync-succeeded: |
    message: |
      ✅ *{{app.metadata.name}}* Sync succeeded
      Namespace: `{{app.spec.destination.namespace}}`
      Revision: `{{app.status.sync.revision}}`
      <{{context.argocdUrl}}/applications/{{app.metadata.name}}|Open in ArgoCD>
  template.slack-sync-failed: |
    message: |
      🔥 *{{app.metadata.name}}* Sync failed
      Status: `{{app.status.operationState.phase}}`
      {{if app.status.operationState.message}}Msg: `{{app.status.operationState.message}}`{{end}}
      <{{context.argocdUrl}}/applications/{{app.metadata.name}}|Open in ArgoCD>
  template.slack-health-degraded: |
    message: |
      ⚠️ *{{app.metadata.name}}* Health: Degraded
      <{{context.argocdUrl}}/applications/{{app.metadata.name}}|Open in ArgoCD>
  template.slack-outofsync: |
    message: |
      ⚠️ *{{app.metadata.name}}* OutOfSync (Drift detected)
      <{{context.argocdUrl}}/applications/{{app.metadata.name}}|Open in ArgoCD>
