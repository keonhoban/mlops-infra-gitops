apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
  labels:
    app.kubernetes.io/part-of: argocd
    app.kubernetes.io/component: notifications-controller
data:
  context: |
    argocdUrl: https://argocd.local

  # 🔹 dev용 Slack 서비스
  service.slack-dev: |
    secretRef: argocd-notifications-dev-secret
    webhook: $slack-webhook-url

  # 🔹 prod용 Slack 서비스
  service.slack-prod: |
    secretRef: argocd-notifications-prod-secret
    webhook: $slack-webhook-url

  # 템플릿 정의
  template.app-sync-succeeded: |
    message: |
      ✅ *{{.app.metadata.name}}* sync 성공
      - Project: `{{.app.spec.project}}`
      - Health : `{{.app.status.health.status}}`
      - URL    : {{.context.argocdUrl}}/applications/{{.app.metadata.name}}

  template.app-sync-failed: |
    message: |
      ❌ *{{.app.metadata.name}}* sync 실패
      - Project: `{{.app.spec.project}}`
      - Reason : {{.app.status.operationState.message}}

  template.app-health-degraded: |
    message: |
      ⚠️ *{{.app.metadata.name}}* Health Degraded
      - 현재 상태: `{{.app.status.health.status}}`
      - URL: {{.context.argocdUrl}}/applications/{{.app.metadata.name}}

  # 트리거 정의
  trigger.on-sync-succeeded: |
    - when: app.status.operationState.phase in ['Succeeded']
      send: [app-sync-succeeded]

  trigger.on-sync-failed: |
    - when: app.status.operationState.phase in ['Error','Failed']
      send: [app-sync-failed]

  trigger.on-health-degraded: |
    - when: app.status.health.status == 'Degraded'
      send: [app-health-degraded]
