apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
  labels:
    app.kubernetes.io/part-of: argocd
    app.kubernetes.io/component: notifications-controller
data:
  context: |
    argocdUrl: https://argocd.local

  # ğŸ”¹ devìš© Slack ì„œë¹„ìŠ¤
  service.slack-dev: |
    secretRef: argocd-notifications-dev-secret
    webhook: $slack-webhook-url

  # ğŸ”¹ prodìš© Slack ì„œë¹„ìŠ¤
  service.slack-prod: |
    secretRef: argocd-notifications-prod-secret
    webhook: $slack-webhook-url

  # í…œí”Œë¦¿ ì •ì˜
  template.app-sync-succeeded: |
    message: |
      âœ… *{{.app.metadata.name}}* sync ì„±ê³µ
      - Project: `{{.app.spec.project}}`
      - Health : `{{.app.status.health.status}}`
      - URL    : {{.context.argocdUrl}}/applications/{{.app.metadata.name}}

  template.app-sync-failed: |
    message: |
      âŒ *{{.app.metadata.name}}* sync ì‹¤íŒ¨
      - Project: `{{.app.spec.project}}`
      - Reason : {{.app.status.operationState.message}}

  template.app-health-degraded: |
    message: |
      âš ï¸ *{{.app.metadata.name}}* Health Degraded
      - í˜„ì¬ ìƒíƒœ: `{{.app.status.health.status}}`
      - URL: {{.context.argocdUrl}}/applications/{{.app.metadata.name}}

  # íŠ¸ë¦¬ê±° ì •ì˜
  trigger.on-sync-succeeded: |
    - when: app.status.operationState.phase in ['Succeeded']
      send: [app-sync-succeeded]

  trigger.on-sync-failed: |
    - when: app.status.operationState.phase in ['Error','Failed']
      send: [app-sync-failed]

  trigger.on-health-degraded: |
    - when: app.status.health.status == 'Degraded'
      send: [app-health-degraded]
