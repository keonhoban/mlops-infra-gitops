apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: mlops-appset
  namespace: argocd
spec:
  generators:
    - list:
        elements:
          - env: dev
            project: dev
            values_suffix: dev
            ns_mlflow: mlflow-dev
            ns_airflow: airflow-dev
            ns_fastapi: fastapi-dev
          - env: prod
            project: prod
            values_suffix: prod
            ns_mlflow: mlflow-prod
            ns_airflow: airflow-prod
            ns_fastapi: fastapi-prod

  template:
    metadata:
      name: '{{name}}'
      annotations:
        # sealed-secrets(0) 다음, 서비스 앱(1) 배포
        argocd.argoproj.io/sync-wave: "1"
    spec:
      project: '{{project}}'
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{namespace}}'
      source:
        repoURL: 'https://github.com/keonhoban/mlops-infra-gitops'
        targetRevision: main
        path: '{{path}}'
        helm:
          releaseName: '{{release}}'
          valueFiles:
            - 'values/base.yaml'
            - 'values/{{values_suffix}}.yaml'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true

  templates:
    # MLflow
    - name: 'mlflow-{{env}}'
      project: '{{project}}'
      namespace: '{{ns_mlflow}}'
      path: 'charts/mlflow'
      release: 'mlflow-{{env}}'

    # Airflow
    - name: 'airflow-{{env}}'
      project: '{{project}}'
      namespace: '{{ns_airflow}}'
      path: 'charts/airflow'
      release: 'airflow-{{env}}'

    # FastAPI (모델 서빙 등)
    - name: 'fastapi-{{env}}'
      project: '{{project}}'
      namespace: '{{ns_fastapi}}'
      path: 'charts/fastapi'
      release: 'fastapi-{{env}}'
