apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: mlops-baseline
  namespace: argocd
spec:
  generators:
    - matrix:
        generators:
          - list:
              elements:
                - env: dev
                  project: dev
                - env: prod
                  project: prod
          - list:
              elements:
                - app: loki
                  ns: observability-{{env}}
                  chart: loki
                  repoURL: https://grafana.github.io/helm-charts
                  targetRevision: 6.52.0
                  valuesFile: baseline/envs/{{env}}/observability/loki-values.yaml
                - app: promtail
                  ns: observability-{{env}}
                  chart: promtail
                  repoURL: https://grafana.github.io/helm-charts
                  targetRevision: 6.16.6
                  valuesFile: baseline/envs/{{env}}/observability/promtail-values.yaml

  template:
    metadata:
      name: '{{app}}-{{env}}'
      labels:
        tier: baseline
        env: '{{env}}'
    spec:
      project: '{{project}}'
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{ns}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - PruneLast=true
      sources:
        # 1) upstream helm chart
        - repoURL: '{{repoURL}}'
          chart: '{{chart}}'
          targetRevision: '{{targetRevision}}'
          helm:
            valueFiles:
              - $values/{{valuesFile}}

        # 2) values repo (this git repo)
        - repoURL: https://github.com/keonhoban/mlops-infra-gitops
          targetRevision: main
          ref: values
